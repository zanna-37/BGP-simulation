/* Copyright (c) 2007 Scott Lembcke
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
var ZoomCharts;!function(t){var i;!function(){}(i=t.Internal||(t.Internal={}))}(ZoomCharts||(ZoomCharts={})),function(){Object.create=Object.create||function(t){function i(){}return i.prototype=t,new i};var t;t={},ZoomCharts.Internal.Chipmunk=t;var i,s,e=function(t,i){if(!t)throw Error("Assertion failed: "+i)},n=function(t,i){!t&&window.console&&console.warn&&(console.warn("ASSERTION FAILED: "+i),console.trace&&console.trace())},r=function(t,i){return t+" "+i};i=Math.min,s=Math.max;var o=function(t,i){for(var s=0;s<t.length;s++)if(t[s]===i)return t[s]=t[t.length-1],void t.length--},a=(t.momentForCircle=function(t,i,s,e){return t*(.5*(i*i+s*s)+B(e))},t.areaForCircle=function(t,i){return Math.PI*Math.abs(t*t-i*i)},t.momentForSegment=function(t,i,s){var e=y(f(s,i)),n=x(d(i,s),.5);return t*(e*e/12+B(n))},t.areaForSegment=function(t,i,s){return s*(Math.PI*s+2*L(t,i))},t.momentForPoly=function(t,i,s){for(var e=0,n=0,r=i.length,o=0;r>o;o+=2){var a=i[o]+s.x,h=i[o+1]+s.y,c=i[(o+2)%r]+s.x,p=i[(o+3)%r]+s.y,l=g(c,p,a,h),u=v(a,h,a,h)+v(a,h,c,p)+v(c,p,c,p);e+=l*u,n+=l}return t*e/(6*n)},t.areaForPoly=function(t){throw Error("Not updated for flat verts")},t.centroidForPoly=function(t){throw Error("Not updated for flat verts")},t.recenterPoly=function(t){throw Error("Not updated for flat verts")},t.momentForBox=function(t,i,s){return t*(i*i+s*s)/12}),h=(t.momentForBox2=function(t,i){return width=i.r-i.l,height=i.t-i.b,offset=x([i.l+i.r,i.b+i.t],.5),a(t,width,height)+t*B(offset)},function(t,e,n){return i(s(t,e),n)}),c=function(t){return s(0,i(t,1))},p=0,l=t.Vect=function(t,i){this.x=t,this.y=i,p++};t.v=function(t,i){return new l(t,i)};var u=t.vzero=new l(0,0),b=t.v.dot=function(t,i){return t.x*i.x+t.y*i.y},v=function(t,i,s,e){return t*s+i*e},y=t.v.len=function(t){return Math.sqrt(b(t,t))},d=(t.v.eql=function(t,i){return t.x===i.x&&t.y===i.y},t.v.add=function(t,i){return new l(t.x+i.x,t.y+i.y)});l.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this};var f=t.v.sub=function(t,i){return new l(t.x-i.x,t.y-i.y)};l.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this};var _=t.v.neg=function(t){return new l(-t.x,-t.y)};l.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var x=t.v.mult=function(t,i){return new l(t.x*i,t.y*i)};l.prototype.mult=function(t){return this.x*=t,this.y*=t,this};var m=t.v.cross=function(t,i){return t.x*i.y-t.y*i.x},g=function(t,i,s,e){return t*e-i*s},w=t.v.perp=function(t){return new l(-t.y,t.x)},S=(t.v.pvrperp=function(t){return new l(t.y,-t.x)},t.v.project=function(t,i){return x(i,b(t,i)/B(i))});l.prototype.project=function(t){return this.mult(b(this,t)/B(t)),this};var A=t.v.rotate=function(t,i){return new l(t.x*i.x-t.y*i.y,t.x*i.y+t.y*i.x)};l.prototype.rotate=function(t){return this.x=this.x*t.x-this.y*t.y,this.y=this.x*t.y+this.y*t.x,this};var j=t.v.unrotate=function(t,i){return new l(t.x*i.x+t.y*i.y,t.y*i.x-t.x*i.y)},B=t.v.lengthsq=function(t){return b(t,t)},C=t.v.lerp=function(t,i,s){return d(x(t,1-s),x(i,s))},M=t.v.normalize=function(t){return x(t,1/y(t))},I=t.v.normalize_safe=function(t){return 0===t.x&&0===t.y?u:M(t)},k=t.v.clamp=function(t,i){return b(t,t)>i*i?x(M(t),i):t},L=(t.v.lerpconst=function(t,i,s){return d(t,k(f(i,t),s))},t.v.dist=function(t,i){return y(f(t,i))}),P=t.v.distsq=function(t,i){return B(f(t,i))},F=(t.v.near=function(t,i,s){return P(t,i)<s*s},t.v.slerp=function(t,i,s){var e=Math.acos(b(t,i));if(e){var n=1/Math.sin(e);return d(x(t,Math.sin((1-s)*e)*n),x(i,Math.sin(s*e)*n))}return t}),N=(t.v.slerpconst=function(t,s,e){var n=Math.acos(b(t,s));return F(t,s,i(e,n)/n)},t.v.forangle=function(t){return new l(Math.cos(t),Math.sin(t))},t.v.toangle=function(t){return Math.atan2(t.y,t.x)},t.v.str=function(t){return"("+t.x.toFixed(3)+", "+t.y.toFixed(3)+")"},0),T=function(t,i,s,e){this.l=t,this.b=i,this.r=s,this.t=e,N++},R=function(t,i,s,e,n){return!(t.l>e||i>t.r||t.b>n||s>t.t)},V=function(t,i,s,e,n){return!(t>n.x||s<n.x||i>n.y||e<n.y)},O=0,Q=(t.NO_GROUP=0,t.ALL_LAYERS=-1);t.resetShapeIdCounter=function(){O=0};var q=t.Shape=function(t){this.body=t,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=O++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=u,this.collision_type=0,this.group=0,this.layers=Q,this.space=null,this.collisionCode=this.collisionCode};q.prototype.setElasticity=function(t){this.e=t},q.prototype.setFriction=function(t){this.body.activate(),this.u=t},q.prototype.setLayers=function(t){this.body.activate(),this.layers=t},q.prototype.active=function(){return this.body&&-1!==this.body.shapeList.indexOf(this)},q.prototype.setBody=function(t){e(!this.active(),"You cannot change the body on an active shape. You must remove the shape, then "),this.body=t},q.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},q.prototype.update=function(t,i){e(!isNaN(i.x),"Rotation is NaN"),e(!isNaN(t.x),"Position is NaN"),this.cacheData(t,i)},q.prototype.getBB=function(){return new T(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var E=function(t){this.shape=t,this.d=1/0,this.n=u},H=function(t,i,s){this.shape=t,this.t=i,this.n=s};H.prototype.hitPoint=function(t,i){return C(t,i,this.t)},H.prototype.hitDist=function(t,i){return L(t,i)*this.t};var D=t.CircleShape=function(t,i,s){this.c=this.tc=s,this.r=i,this.type="circle",q.call(this,t)};D.prototype=Object.create(q.prototype),D.prototype.cacheData=function(t,i){var s=this.tc=A(this.c,i).add(t),e=this.r;this.bb_l=s.x-e,this.bb_b=s.y-e,this.bb_r=s.x+e,this.bb_t=s.y+e},D.prototype.pointQuery=function(t){var i=f(t,this.tc),s=B(i),e=this.r;if(e*e>s){var n=new E(this),r=Math.sqrt(s);return n.d=e-r,n.n=x(i,1/r),n}};var G=function(t,i,s,e,n){e=f(e,i),n=f(n,i);var r=b(e,e)-2*b(e,n)+b(n,n),o=-2*b(e,e)+2*b(e,n),a=b(e,e)-s*s,h=o*o-4*r*a;if(h>=0){var c=(-o-Math.sqrt(h))/(2*r);if(c>=0&&1>=c)return new H(t,c,M(C(e,n,c)))}};D.prototype.segmentQuery=function(t,i){return G(this,this.tc,this.r,t,i)};var W=t.SegmentShape=function(t,i,s,e){this.a=i,this.b=s,this.n=w(M(f(s,i))),this.ta=this.tb=this.tn=null,this.r=e,this.a_tangent=u,this.b_tangent=u,this.type="segment",q.call(this,t)};W.prototype=Object.create(q.prototype),W.prototype.cacheData=function(t,i){this.ta=d(t,A(this.a,i)),this.tb=d(t,A(this.b,i)),this.tn=A(this.n,i);var s,e,n,r;this.ta.x<this.tb.x?(s=this.ta.x,e=this.tb.x):(s=this.tb.x,e=this.ta.x),this.ta.y<this.tb.y?(n=this.ta.y,r=this.tb.y):(n=this.tb.y,r=this.ta.y);var o=this.r;this.bb_l=s-o,this.bb_b=n-o,this.bb_r=e+o,this.bb_t=r+o},W.prototype.pointQuery=function(t){if(V(this.bb_l,this.bb_b,this.bb_r,this.bb_t,t)){var i=this.ta,s=this.tb,e=f(s,i),n=c(b(e,f(t,i))/B(e)),r=d(i,x(e,n)),o=f(t,r),a=B(o),h=this.r;if(h*h>a){var p=new E(this),l=Math.sqrt(a);return p.d=h-l,p.n=x(o,1/l),p}}},W.prototype.segmentQuery=function(t,i){var s=this.tn,e=b(f(this.ta,t),s),n=this.r,r=e>0?_(s):s,o=f(x(r,n),t),a=d(this.ta,o),h=d(this.tb,o),c=f(i,t);if(m(c,a)*m(c,h)>0){if(0!=n){var p=G(this,this.ta,this.r,t,i),l=G(this,this.tb,this.r,t,i);return p?l&&l.t<p.t?l:p:l}}else{var u=e+(e>0?-n:n),v=-u,y=b(c,s)-u;if(0>v*y)return new H(this,v/(v-y),r)}},W.prototype.setNeighbors=function(t,i){this.a_tangent=f(t,this.a),this.b_tangent=f(i,this.b)},W.prototype.setEndpoints=function(t,i){this.a=t,this.b=i,this.n=w(M(f(i,t)))};var z=function(t){for(var i=t.length,s=0;i>s;s+=2){var e=t[s],n=t[s+1],r=t[(s+2)%i],o=t[(s+3)%i],a=t[(s+4)%i],h=t[(s+5)%i];if(g(r-e,o-n,a-r,h-o)>0)return!1}return!0},J=t.PolyShape=function(t,i,s){e(i.length>=4,"Polygons require some verts"),e("number"==typeof i[0],"Polygon verticies should be specified in a flattened list"),e(z(i),"Polygon is concave or has a reversed winding."),this.setVerts(i,s),this.type="poly",q.call(this,t)};J.prototype=Object.create(q.prototype);var U=function(t,i){this.n=t,this.d=i};J.prototype.setVerts=function(t,i){var s=t.length,e=s>>1;this.verts=Array(s),this.tVerts=Array(s),this.axes=Array(e),this.tAxes=Array(e);for(var n=0;s>n;n+=2){var r=t[n]+i.x,o=t[n+1]+i.y,a=t[(n+2)%s]+i.x,h=t[(n+3)%s]+i.y,c=M(w(new l(a-r,h-o)));this.verts[n]=r,this.verts[n+1]=o,this.axes[n>>1]=new U(c,v(c.x,c.y,r,o)),this.tAxes[n>>1]=new U(new l(0,0),0)}};var Y=(t.BoxShape=function(t,i,s){var e=i/2,n=s/2;return Y(t,new T(-e,-n,e,n))},t.BoxShape2=function(t,i){var s=[i.l,i.b,i.l,i.t,i.r,i.t,i.r,i.b];return new J(t,s,u)});J.prototype.transformVerts=function(t,e){for(var n=this.verts,r=this.tVerts,o=1/0,a=-1/0,h=1/0,c=-1/0,p=0;p<n.length;p+=2){var l=n[p],u=n[p+1],b=t.x+l*e.x-u*e.y,v=t.y+l*e.y+u*e.x;r[p]=b,r[p+1]=v,o=i(o,b),a=s(a,b),h=i(h,v),c=s(c,v)}this.bb_l=o,this.bb_b=h,this.bb_r=a,this.bb_t=c},J.prototype.transformAxes=function(t,i){for(var s=this.axes,e=this.tAxes,n=0;n<s.length;n++){var r=A(s[n].n,i);e[n].n=r,e[n].d=b(t,r)+s[n].d}},J.prototype.cacheData=function(t,i){this.transformAxes(t,i),this.transformVerts(t,i)},J.prototype.pointQuery=function(t){if(V(this.bb_l,this.bb_b,this.bb_r,this.bb_t,t)){for(var i=new E(this),s=this.tAxes,e=0;e<s.length;e++){var n=s[e].n,r=s[e].d-b(n,t);if(0>r)return;r<i.d&&(i.d=r,i.n=n)}return i}},J.prototype.segmentQuery=function(t,i){for(var s=this.tAxes,e=this.tVerts,n=s.length,r=2*n,o=0;n>o;o++){var a=s[o].n,h=b(t,a);if(s[o].d<=h){var c=b(i,a),p=(s[o].d-h)/(c-h);if(p>=0&&1>=p){var l=C(t,i,p),u=-m(a,l),v=-g(a.x,a.y,e[2*o],e[2*o+1]),y=-g(a.x,a.y,e[(2*o+2)%r],e[(2*o+3)%r]);if(u>=v&&y>=u)return new H(this,p,a)}}}},J.prototype.valueOnAxis=function(t,s){for(var e=this.tVerts,n=v(t.x,t.y,e[0],e[1]),r=2;r<e.length;r+=2)n=i(n,v(t.x,t.y,e[r],e[r+1]));return n-s},J.prototype.containsVert=function(t,i){for(var s=this.tAxes,e=0;e<s.length;e++){var n=s[e].n,r=v(n.x,n.y,t,i)-s[e].d;if(r>0)return!1}return!0},J.prototype.containsVertPartial=function(t,i,s){for(var e=this.tAxes,n=0;n<e.length;n++){var s=e[n].n;if(b(s,s)>=0){var r=v(s.x,s.y,t,i)-e[n].d;if(r>0)return!1}}return!0};var Z=t.Body=function(t,i){Z.prototype.velocity_func=Z.prototype.updateVelocity,Z.prototype.position_func=Z.prototype.updatePosition,this.p=new l(0,0),this.vx=this.vy=0,this.f=new l(0,0),this.w=0,this.t=0,this.v_limit=1/0,this.w_limit=1/0,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(t),this.setMoment(i),this.rot=new l(0,0),this.setAngle(0)};if("undefined"!=typeof DEBUG&&DEBUG){var K=function(t,i){e(t.x==t.x&&t.y==t.y,i)},X=function(t,i){e(1/0!==Math.abs(t.x)&&1/0!==Math.abs(t.y),i)},$=function(t,i){K(t,i),X(t,i)};Z.prototype.sanityCheck=function(){e(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),e(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),$(this.p,"Body's position is invalid."),$(this.f,"Body's force is invalid."),e(this.vx===this.vx&&1/0!==Math.abs(this.vx),"Body's velocity is invalid."),e(this.vy===this.vy&&1/0!==Math.abs(this.vy),"Body's velocity is invalid."),e(this.a===this.a&&1/0!==Math.abs(this.a),"Body's angle is invalid."),e(this.w===this.w&&1/0!==Math.abs(this.w),"Body's angular velocity is invalid."),e(this.t===this.t&&1/0!==Math.abs(this.t),"Body's torque is invalid."),$(this.rot,"Internal error: Body's rotation vector is invalid."),e(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),e(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else Z.prototype.sanityCheck=function(){};Z.prototype.isSleeping=function(){return null!==this.nodeRoot},Z.prototype.isStatic=function(){return 1/0===this.nodeIdleTime},Z.prototype.isRogue=function(){return null===this.space},Z.prototype.setMass=function(t){e(t>0,"Mass must be positive and non-zero."),this.activate(),this.m=t,this.m_inv=1/t},Z.prototype.setMoment=function(t){e(t>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=t,this.i_inv=1/t},Z.prototype.addShape=function(t){this.shapeList.push(t)},Z.prototype.removeShape=function(t){o(this.shapeList,t)};var ti=function(t,i,s){return t===s?t.next(i):(t.a===i?t.next_a=ti(t.next_a,i,s):t.next_b=ti(t.next_b,i,s),t)};Z.prototype.removeConstraint=function(t){this.constraintList=ti(this.constraintList,this,t)},Z.prototype.setPos=function(t){this.activate(),this.sanityCheck(),this.p=t},Z.prototype.setVelocity=function(t){this.activate(),this.vx=t.x,this.vy=t.y},Z.prototype.setAngleInternal=function(t){e(!isNaN(t),"Internal Error: Attempting to set body's angle to NaN"),this.a=t,this.rot.x=Math.cos(t),this.rot.y=Math.sin(t)},Z.prototype.setAngle=function(t){this.activate(),this.sanityCheck(),this.setAngleInternal(t)},Z.prototype.updateVelocity=function(t,i,s){var e=this.vx*i+(t.x+this.f.x*this.m_inv)*s,n=this.vy*i+(t.y+this.f.y*this.m_inv)*s,r=this.v_limit,o=e*e+n*n,a=o>r*r?r/Math.sqrt(len):1;this.vx=e*a,this.vy=n*a;var c=this.w_limit;this.w=h(this.w*i+this.t*this.i_inv*s,-c,c),this.sanityCheck()},Z.prototype.updatePosition=function(t){this.p.x+=(this.vx+this.v_biasx)*t,this.p.y+=(this.vy+this.v_biasy)*t,this.setAngleInternal(this.a+(this.w+this.w_bias)*t),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},Z.prototype.resetForces=function(){this.activate(),this.f=new l(0,0),this.t=0},Z.prototype.applyForce=function(t,i){this.activate(),this.f=d(this.f,t),this.t+=m(i,t)},Z.prototype.applyImpulse=function(t,i){this.activate(),ns(this,t.x,t.y,i)},Z.prototype.getVelAtPoint=function(t){return d(new l(this.vx,this.vy),x(w(t),body.w))},Z.prototype.getVelAtWorldPoint=function(t){return this.getVelAtPoint(f(t,body.p))},Z.prototype.getVelAtLocalPoint=function(t){return this.getVelAtPoint(A(t,body.rot))},Z.prototype.eachShape=function(t){for(var i=0,s=this.shapeList.length;s>i;i++)t(this.shapeList[i])},Z.prototype.eachConstraint=function(t){for(var i=this.constraintList;i;){var s=i.next(body);t(i),i=s}},Z.prototype.eachArbiter=function(t){for(var i=this.arbiterList;i;){var s=i.next(body);i.swappedColl=this===i.body_b,t(i),i=s}},Z.prototype.local2World=function(t){return d(this.p,A(t,this.rot))},Z.prototype.world2Local=function(t){return j(f(t,this.p),this.rot)},Z.prototype.kineticEnergy=function(){var t=this.vx*this.vx+this.vy*this.vy,i=this.w*this.w;return(t?t*this.m:0)+(i?i*this.i:0)};var ii=t.SpatialIndex=function(t){this.staticIndex=t,t&&(e(!t.dynamicIndex,"This static index is already associated with a dynamic index."),t.dynamicIndex=this)};ii.prototype.collideStatic=function(t,i){if(t.count>0){var s=t.query;this.each(function(t){s(t,new T(t.bb_l,t.bb_b,t.bb_r,t.bb_t),i)})}};var si=t.BBTree=function(t){ii.call(this,t),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.stamp=0};si.prototype=Object.create(ii.prototype);var ei=0,ni=function(t,e,n){this.obj=null,this.bb_l=i(e.bb_l,n.bb_l),this.bb_b=i(e.bb_b,n.bb_b),this.bb_r=s(e.bb_r,n.bb_r),this.bb_t=s(e.bb_t,n.bb_t),this.parent=null,this.setA(e),this.setB(n),ei++},ri=0,oi=function(t,i){this.obj=i,t.getBB(i,this),this.parent=null,this.stamp=1,this.pairs=null,ri++};si.prototype.getBB=function(t,e){var n=this.velocityFunc;if(n){var r=.1,o=(t.bb_r-t.bb_l)*r,a=(t.bb_t-t.bb_b)*r,h=x(n(t),.1);e.bb_l=t.bb_l+i(-o,h.x),e.bb_b=t.bb_b+i(-a,h.y),e.bb_r=t.bb_r+s(o,h.x),e.bb_t=t.bb_t+s(a,h.y)}else e.bb_l=t.bb_l,e.bb_b=t.bb_b,e.bb_r=t.bb_r,e.bb_t=t.bb_t},si.prototype.getStamp=function(){var t=this.dynamicIndex;return t&&t.stamp?t.stamp:this.stamp},si.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var ai=function(t,i){this.a=t,this.b=i},hi=function(t,i){this.prev=null,this.next=i,this.leaf=t};hi.prototype.unlink=function(){var t=this.next,i=this.prev;t&&(t.a.leaf==this.leaf?t.a.prev=i:t.b.prev=i),i?i.a.leaf==this.leaf?i.a.next=t:i.b.next=t:this.leaf.pairs=t},oi.prototype.clearPairs=function(){var t,i=this.pairs;for(this.pairs=null;i;)i.a.leaf==this?(t=i.a.next,i.b.unlink(),i=t):(t=i.b.next,i.a.unlink(),i=t)};var ci=function(t,i){var s=t.pairs,e=i.pairs,n=new ai(new hi(t,s),new hi(i,e));t.pairs=i.pairs=n,s&&(s.a.leaf==t?s.a.prev=n:s.b.prev=n),e&&(e.a.leaf==i?e.a.prev=n:e.b.prev=n)};ni.prototype.setA=function(t){this.A=t,t.parent=this},ni.prototype.setB=function(t){this.B=t,t.parent=this},oi.prototype.isLeaf=!0,ni.prototype.isLeaf=!1,ni.prototype.otherChild=function(t){return this.A==t?this.B:this.A},ni.prototype.replaceChild=function(t,e){n(t==this.A||t==this.B,"Node is not a child of parent."),this.A==t?this.setA(e):this.setB(e);for(var r=this;r;r=r.parent){var o=r.A,a=r.B;r.bb_l=i(o.bb_l,a.bb_l),r.bb_b=i(o.bb_b,a.bb_b),r.bb_r=s(o.bb_r,a.bb_r),r.bb_t=s(o.bb_t,a.bb_t)}},ni.prototype.bbArea=oi.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var pi=function(t,e){return(s(t.bb_r,e.bb_r)-i(t.bb_l,e.bb_l))*(s(t.bb_t,e.bb_t)-i(t.bb_b,e.bb_b))},li=function(t,i){return Math.abs(t.bb_l+t.bb_r-i.bb_l-i.bb_r)+Math.abs(t.bb_b+i.bb_t-i.bb_b-i.bb_t)},ui=function(t,e,n){if(null==t)return e;if(t.isLeaf)return new ni(n,e,t);var r=t.B.bbArea()+pi(t.A,e),o=t.A.bbArea()+pi(t.B,e);return r===o&&(r=li(t.A,e),o=li(t.B,e)),r>o?t.setB(ui(t.B,e,n)):t.setA(ui(t.A,e,n)),t.bb_l=i(t.bb_l,e.bb_l),t.bb_b=i(t.bb_b,e.bb_b),t.bb_r=s(t.bb_r,e.bb_r),t.bb_t=s(t.bb_t,e.bb_t),t};ni.prototype.intersectsBB=oi.prototype.intersectsBB=function(t){return!(this.bb_l>t.r||t.l>this.bb_r||this.bb_b>t.t||t.b>this.bb_t)};var bi=function(t,i,s){t.intersectsBB(i)&&(t.isLeaf?s(t.obj):(bi(t.A,i,s),bi(t.B,i,s)))},vi=function(t,e,n){var r=1/(n.x-e.x),o=t.bb_l==e.x?-1/0:(t.bb_l-e.x)*r,a=t.bb_r==e.x?1/0:(t.bb_r-e.x)*r,h=i(o,a),c=s(o,a),p=1/(n.y-e.y),l=t.bb_b==e.y?-1/0:(t.bb_b-e.y)*p,u=t.bb_t==e.y?1/0:(t.bb_t-e.y)*p,b=i(l,u),v=s(l,u);if(c>=b&&v>=h){var y=s(h,b),d=i(c,v);if(d>=0&&1>=y)return s(y,0)}return 1/0},yi=function(t,s,e,n,r){if(t.isLeaf)return r(t.obj);var o=vi(t.A,s,e),a=vi(t.B,s,e);return a>o?(n>o&&(n=i(n,yi(t.A,s,e,n,r))),n>a&&(n=i(n,yi(t.B,s,e,n,r)))):(n>a&&(n=i(n,yi(t.B,s,e,n,r))),n>o&&(n=i(n,yi(t.A,s,e,n,r)))),n},di=function(t,i,s){if(i==t)return null;var e=i.parent;if(e==t){var n=t.otherChild(i);return n.parent=t.parent,n}return e.parent.replaceChild(e,e.otherChild(i),s),t},fi=function(t,i){return!(t.bb_l>i.bb_r||i.bb_l>t.bb_r||t.bb_b>i.bb_t||i.bb_b>t.bb_t)},_i=function(t,i,s,e,n){fi(i,t)&&(t.isLeaf?s?ci(i,t,e):(t.stamp<i.stamp&&ci(t,i,e),n&&n(i.obj,t.obj)):(_i(t.A,i,s,e,n),_i(t.B,i,s,e,n)))},xi=function(t,i,s,e){if(t.stamp==i.getStamp()){s&&_i(s,t,!1,i,e);for(var n=t;n.parent;n=n.parent)n==n.parent.A?_i(n.parent.B,t,!0,i,e):_i(n.parent.A,t,!1,i,e)}else for(var r=t.pairs;r;)t==r.b.leaf?(e&&e(r.a.leaf.obj,t.obj),r=r.b.next):r=r.a.next},mi=function(t,i,s,e){t.isLeaf?xi(t,i,s,e):(mi(t.A,i,s,e),mi(t.B,i,s,e))};oi.prototype.containsObj=function(t){return!(this.bb_l>t.bb_l||this.bb_r<t.bb_r||this.bb_b>t.bb_b||this.bb_t<t.bb_t)},oi.prototype.update=function(t){var i=t.root,s=this.obj;return this.containsObj(s)?!1:(t.getBB(this.obj,this),i=di(i,this,t),t.root=ui(i,this,t),this.clearPairs(t),this.stamp=t.getStamp(),!0)},oi.prototype.addPairs=function(t){var i=t.dynamicIndex;if(i){var s=i.root;s&&_i(s,this,!0,i,null)}else{var e=t.staticIndex.root;xi(this,t,e,null)}},si.prototype.insert=function(t,i){var s=new oi(this,t);this.leaves[i]=s,this.root=ui(this.root,s,this),this.count++,s.stamp=this.getStamp(),s.addPairs(this),this.incrementStamp()},si.prototype.remove=function(t,i){var s=this.leaves[i];delete this.leaves[i],this.root=di(this.root,s,this),this.count--,s.clearPairs(this)},si.prototype.contains=function(t,i){return null!=this.leaves[i]};var gi=function(){};si.prototype.reindexQuery=function(t){if(this.root){var i,s=this.leaves;for(i in s)s[i].update(this);var e=this.staticIndex,n=e&&e.root;mi(this.root,this,n,t),e&&!n&&this.collideStatic(this,e,t),this.incrementStamp()}},si.prototype.reindex=function(){this.reindexQuery(gi)},si.prototype.reindexObject=function(t,i){var s=this.leaves[i];s&&(s.update(this)&&s.addPairs(this),this.incrementStamp())},si.prototype.pointQuery=function(t,i){this.root&&bi(this.root,new T(t.x,t.y,t.x,t.y),i)},si.prototype.segmentQuery=function(t,i,s,e){this.root&&yi(this.root,t,i,s,e)},si.prototype.query=function(t,i){this.root&&bi(this.root,t,i)},si.prototype.count=function(){return this.count},si.prototype.each=function(t){var i;for(i in this.leaves)t(this.leaves[i].obj)};var wi=function(t,e,n,r,o){return(s(t.bb_r,r)-i(t.bb_l,e))*(s(t.bb_t,o)-i(t.bb_b,n))},Si=function(t,e,n,r){if(1==r)return e[n];if(2==r)return new ni(t,e[n],e[n+1]);for(var o=e[n],a=o.bb_l,h=o.bb_b,c=o.bb_r,p=o.bb_t,l=n+r,u=n+1;l>u;u++)o=e[u],a=i(a,o.bb_l),h=i(h,o.bb_b),c=s(c,o.bb_r),p=s(p,o.bb_t);var b=c-a>p-h,v=Array(2*r);if(b)for(var u=n;l>u;u++)v[2*u+0]=e[u].bb_l,v[2*u+1]=e[u].bb_r;else for(var u=n;l>u;u++)v[2*u+0]=e[u].bb_b,v[2*u+1]=e[u].bb_t;v.sort(function(t,i){return t-i});var y=.5*(v[r-1]+v[r]),d=a,f=h,_=c,x=p,m=a,g=h,w=c,S=p;b?_=m=y:x=g=y;for(var A=l,j=n;A>j;){var o=e[j];wi(o,m,g,w,S)<wi(o,d,f,_,x)?(A--,e[j]=e[A],e[A]=o):j++}if(A==r){for(var o=null,u=n;l>u;u++)o=ui(o,e[u],t);return o}return NodeNew(t,Si(t,e,n,A-n),Si(t,e,A,l-A))};si.prototype.optimize=function(){var t=Array(this.count),i=0;for(var s in this.leaves)t[i++]=this.nodes[s];this.root=Si(tree,t,t.length)};var Ai=function(t,i){t.isLeaf||i>10||(Ai(t.a,i+1),Ai(t.b,i+1));for(var s="",e=0;i>e;e++)s+=" "};si.prototype.log=function(){this.root&&Ai(this.root,0)};var ji=t.CollisionHandler=function(){this.a=this.b=0};ji.prototype.begin=function(){return!0},ji.prototype.preSolve=function(){return!0},ji.prototype.postSolve=function(){},ji.prototype.separate=function(){};var Bi=function(t,i){this.e=0,this.u=0,this.surface_vr=u,this.a=t,this.body_a=t.body,this.b=i,this.body_b=i.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};Bi.prototype.totalImpulse=function(){for(var t=this.contacts,i=new l(0,0),s=0,e=t.length;e>s;s++){var n=t[s];i.add(x(n.n,n.jnAcc))}return this.swappedColl?i:i.neg()},Bi.prototype.totalImpulseWithFriction=function(){for(var t=this.contacts,i=new l(0,0),s=0,e=t.length;e>s;s++){var n=t[s];i.add(new l(n.jnAcc,n.jtAcc).rotate(n.n))}return this.swappedColl?i:i.neg()},Bi.prototype.totalKE=function(){for(var t=(1-arb.e)/(1+arb.e),i=0,s=arb.contacts,e=0,n=s.length;n>e;e++){var r=s[e],o=r.jnAcc,a=r.jtAcc;i+=t*o*o/r.nMass+a*a/r.tMass}return i},Bi.prototype.ignore=function(){this.state="ignore"},Bi.prototype.getA=function(){return this.swappedColl?this.b:this.a},Bi.prototype.getB=function(){return this.swappedColl?this.a:this.b},Bi.prototype.isFirstContact=function(){return"first coll"===this.state};var Ci=function(t,i,s){this.point=t,this.normal=i,this.dist=s};Bi.prototype.getContactPointSet=function(){var t,i=Array(this.contacts.length);for(t=0;t<i.length;t++)i[t]=new Ci(this.contacts[t].p,this.contacts[t].n,this.contacts[t].dist);return i},Bi.prototype.getNormal=function(t){var i=this.contacts[t].n;return this.swappedColl?_(i):i},Bi.prototype.getPoint=function(t){return this.contacts[t].p},Bi.prototype.getDepth=function(t){return this.contacts[t].dist};var Mi=function(t,i,s,e){s?s.body_a===i?s.thread_a_next=e:s.thread_b_next=e:i.arbiterList=e,e&&(e.body_a===i?e.thread_a_prev=s:e.thread_b_prev=s)};Bi.prototype.unthread=function(){Mi(this,this.body_a,this.thread_a_prev,this.thread_a_next),Mi(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},Bi.prototype.update=function(t,i,s,e){if(this.contacts)for(var n=0;n<this.contacts.length;n++)for(var r=this.contacts[n],o=0;o<t.length;o++){var a=t[o];a.hash===r.hash&&(a.jnAcc=r.jnAcc,a.jtAcc=r.jtAcc)}this.contacts=t,this.handler=i,this.swappedColl=s.collision_type!==i.a,this.e=s.e*e.e,this.u=s.u*e.u,this.surface_vr=f(s.surface_v,e.surface_v),this.a=s,this.body_a=s.body,this.b=e,this.body_b=e.body,"cached"==this.state&&(this.state="first coll")},Bi.prototype.preStep=function(t,s,e){for(var n=this.body_a,r=this.body_b,o=0;o<this.contacts.length;o++){var a=this.contacts[o];a.r1=f(a.p,n.p),a.r2=f(a.p,r.p),a.nMass=1/hs(n,r,a.r1,a.r2,a.n),a.tMass=1/hs(n,r,a.r1,a.r2,w(a.n)),a.bias=-e*i(0,a.dist+s)/t,a.jBias=0,a.bounce=es(n,r,a.r1,a.r2,a.n)*this.e}},Bi.prototype.applyCachedImpulse=function(t){if(!this.isFirstContact())for(var i=this.body_a,s=this.body_b,e=0;e<this.contacts.length;e++){var n=this.contacts[e],r=n.n.x,o=n.n.y,a=r*n.jnAcc-o*n.jtAcc,h=r*n.jtAcc+o*n.jnAcc;rs(i,s,n.r1,n.r2,a*t,h*t)}};var Ii=0,ki=0;Bi.prototype.applyImpulse=function(){Ii++;for(var t=this.body_a,i=this.body_b,e=this.surface_vr,n=this.u,r=0;r<this.contacts.length;r++){ki++;var o=this.contacts[r],a=o.nMass,c=o.n,p=o.r1,l=o.r2,u=i.vx-l.y*i.w-(t.vx-p.y*t.w),b=i.vy+l.x*i.w-(t.vy+p.x*t.w),y=c.x*(i.v_biasx-l.y*i.w_bias-t.v_biasx+p.y*t.w_bias)+c.y*(l.x*i.w_bias+i.v_biasy-p.x*t.w_bias-t.v_biasy),d=v(u,b,c.x,c.y),f=v(u+e.x,b+e.y,-c.y,c.x),_=(o.bias-y)*a,x=o.jBias;o.jBias=s(x+_,0);var m=-(o.bounce+d)*a,g=o.jnAcc;o.jnAcc=s(g+m,0);var w=n*o.jnAcc,S=-f*o.tMass,A=o.jtAcc;o.jtAcc=h(A+S,-w,w);var j=c.x*(o.jBias-x),B=c.y*(o.jBias-x);os(t,-j,-B,p),os(i,j,B,l);var C=o.jnAcc-g,M=o.jtAcc-A;rs(t,i,p,l,c.x*C-c.y*M,c.x*M+c.y*C)}},Bi.prototype.callSeparate=function(t){var i=t.lookupHandler(this.a.collision_type,this.b.collision_type);i.separate(this,t)},Bi.prototype.next=function(t){return this.body_a==t?this.thread_a_next:this.thread_b_next};var Li=0,Pi=function(t,i,s,e){this.p=t,this.n=i,this.dist=s,this.r1=this.r2=u,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=e,Li++},Fi=[],Ni=function(t,i,s,e){var n=s+e,r=f(i,t),o=B(r);if(n*n>o){var a=Math.sqrt(o);return new Pi(d(t,x(r,.5+(s-.5*n)/(a?a:1/0))),a?x(r,1/a):new l(1,0),a-n,0)}},Ti=function(t,i){var s=Ni(t.tc,i.tc,t.r,i.r);return s?[s]:Fi},Ri=function(t,i){var s=i.ta,e=i.tb,n=t.tc,r=f(e,s),o=c(b(r,f(n,s))/B(r)),a=d(s,x(r,o)),h=Ni(n,a,t.r,i.r);if(h){var p=h.n;return 0===o&&b(p,i.a_tangent)<0||1===o&&b(p,i.b_tangent)<0?Fi:[h]}return Fi},Vi=0,Oi=function(t,i){var s=0,e=t.valueOnAxis(i[0].n,i[0].d);if(e>0)return-1;for(var n=1;n<i.length;n++){var r=t.valueOnAxis(i[n].n,i[n].d);if(r>0)return-1;r>e&&(e=r,s=n)}return Vi=e,s},Qi=function(t,i,s,e){for(var n=[],o=t.tVerts,a=0;a<o.length;a+=2){var h=o[a],c=o[a+1];i.containsVertPartial(h,c,_(s))&&n.push(new Pi(new l(h,c),s,e,r(t.hashid,a)))}for(var p=i.tVerts,a=0;a<p.length;a+=2){var h=p[a],c=p[a+1];t.containsVertPartial(h,c,s)&&n.push(new Pi(new l(h,c),s,e,r(i.hashid,a)))}return n},qi=function(t,i,s,e){for(var n=[],o=t.tVerts,a=0;a<o.length;a+=2){var h=o[a],c=o[a+1];i.containsVert(h,c)&&n.push(new Pi(new l(h,c),s,e,r(t.hashid,a>>1)))}for(var p=i.tVerts,a=0;a<p.length;a+=2){var h=p[a],c=p[a+1];t.containsVert(h,c)&&n.push(new Pi(new l(h,c),s,e,r(i.hashid,a>>1)))}return n.length?n:Qi(t,i,s,e)},Ei=function(t,i){var s=Oi(i,t.tAxes);if(-1==s)return Fi;var e=Vi,n=Oi(t,i.tAxes);if(-1==n)return Fi;var r=Vi;return e>r?qi(t,i,t.tAxes[s].n,e):qi(t,i,_(i.tAxes[n].n),r)},Hi=function(t,s,e){var n=b(s,t.ta)-t.r,r=b(s,t.tb)-t.r;return i(n,r)-e},Di=function(t,i,s,e,n){for(var o=m(i.tn,i.ta),a=m(i.tn,i.tb),h=x(i.tn,n),c=s.tVerts,p=0;p<c.length;p+=2){var u=c[p],y=c[p+1];if(v(u,y,h.x,h.y)<b(i.tn,i.ta)*n+i.r){var d=g(i.tn.x,i.tn.y,u,y);d>o||a>d||t.push(new Pi(new l(u,y),h,e,r(s.hashid,p)))}}},Gi=function(t,i){var s=[],e=i.tAxes,n=e.length,o=b(t.tn,t.ta),a=i.valueOnAxis(t.tn,o)-t.r,h=i.valueOnAxis(_(t.tn),-o)-t.r;if(h>0||a>0)return Fi;var c=0,p=Hi(t,e[0].n,e[0].d);if(p>0)return Fi;for(var u=0;n>u;u++){var v=Hi(t,e[u].n,e[u].d);if(v>0)return Fi;v>p&&(p=v,c=u)}var y=_(e[c].n),f=d(t.ta,x(y,t.r)),m=d(t.tb,x(y,t.r));if(i.containsVert(f.x,f.y)&&s.push(new Pi(f,y,p,r(t.hashid,0))),i.containsVert(m.x,m.y)&&s.push(new Pi(m,y,p,r(t.hashid,1))),p>a&&p>h||(a>h?Di(s,t,i,a,1):Di(s,t,i,h,-1)),0===s.length){var g,w=2*c,S=i.tVerts,A=new l(S[w],S[w+1]);if(g=Ni(t.ta,A,t.r,0,s))return[g];if(g=Ni(t.tb,A,t.r,0,s))return[g];var j=2*n,B=new l(S[(w+2)%j],S[(w+3)%j]);if(g=Ni(t.ta,B,t.r,0,s))return[g];if(g=Ni(t.tb,B,t.r,0,s))return[g]}return s},Wi=function(t,i){for(var s=i.tAxes,e=0,n=b(s[0].n,t.tc)-s[0].d-t.r,r=0;r<s.length;r++){var o=b(s[r].n,t.tc)-s[r].d-t.r;if(o>0)return Fi;o>n&&(n=o,e=r)}var a=s[e].n,h=i.tVerts,c=h.length,p=e<<1,u=h[p],v=h[p+1],y=h[(p+2)%c],d=h[(p+3)%c],w=g(a.x,a.y,u,v),S=g(a.x,a.y,y,d),A=m(a,t.tc);if(S>A){var j=Ni(t.tc,new l(y,d),t.r,0,j);return j?[j]:Fi}if(w>A)return[new Pi(f(t.tc,x(a,t.r+n/2)),_(a),n,0)];var j=Ni(t.tc,new l(u,v),t.r,0,j);return j?[j]:Fi};D.prototype.collisionCode=0,W.prototype.collisionCode=1,J.prototype.collisionCode=2,D.prototype.collisionTable=[Ti,Ri,Wi],W.prototype.collisionTable=[null,function(){return Fi},Gi],J.prototype.collisionTable=[null,null,Ei];var zi=t.collideShapes=function(t,i){return e(t.collisionCode<=i.collisionCode,"Collided shapes must be sorted by type"),t.collisionTable[i.collisionCode](t,i)},Ji=new ji,Ui=t.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new si(null),this.activeShapes=new si(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=Ji,this.postStepCallbacks=[],this.iterations=10,this.gravity=u,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=1/0,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new Z(1/0,1/0),this.staticBody.nodeIdleTime=1/0,this.collideShapes=this.makeCollideShapes()};Ui.prototype.isLocked=function(){return this.locked};var Yi=function(t){e(!t.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};Ui.prototype.addCollisionHandler=function(t,i,s,e,n,o){Yi(this),this.removeCollisionHandler(t,i);var a=new ji;a.a=t,a.b=i,s&&(a.begin=s),e&&(a.preSolve=e),n&&(a.postSolve=n),o&&(a.separate=o),this.collisionHandlers[r(t,i)]=a},Ui.prototype.removeCollisionHandler=function(t,i){Yi(this),delete this.collisionHandlers[r(t,i)]},Ui.prototype.setDefaultCollisionHandler=function(t,i,s,e){Yi(this);var n=new ji;t&&(n.begin=t),i&&(n.preSolve=i),s&&(n.postSolve=s),e&&(n.separate=e),this.defaultHandler=n},Ui.prototype.lookupHandler=function(t,i){return this.collisionHandlers[r(t,i)]||this.defaultHandler},Ui.prototype.addShape=function(t){var i=t.body;return i.isStatic()?this.addStaticShape(t):(e(!t.space,"This shape is already added to a space and cannot be added to another."),Yi(this),i.activate(),i.addShape(t),t.update(i.p,i.rot),this.activeShapes.insert(t,t.hashid),t.space=this,t)},Ui.prototype.addStaticShape=function(t){e(!t.space,"This shape is already added to a space and cannot be added to another."),Yi(this);var i=t.body;return i.addShape(t),t.update(i.p,i.rot),this.staticShapes.insert(t,t.hashid),t.space=this,t},Ui.prototype.addBody=function(t){return e(!t.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),e(!t.space,"This body is already added to a space and cannot be added to another."),Yi(this),this.bodies.push(t),t.space=this,t},Ui.prototype.addConstraint=function(t){e(!t.space,"This shape is already added to a space and cannot be added to another."),Yi(this);var i=t.a,s=t.b;return i.activate(),s.activate(),this.constraints.push(t),t.next_a=i.constraintList,i.constraintList=t,t.next_b=s.constraintList,s.constraintList=t,t.space=this,t},Ui.prototype.filterArbiters=function(t,i){for(var s in this.cachedArbiters){var e=this.cachedArbiters[s];(t===e.body_a&&(i===e.a||null===i)||t===e.body_b&&(i===e.b||null===i))&&(i&&"cached"!==e.state&&e.callSeparate(this),e.unthread(),o(this.arbiters,e),delete this.cachedArbiters[s])}},Ui.prototype.removeShape=function(t){var i=t.body;i.isStatic()?this.removeStaticShape(t):(e(this.containsShape(t),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),Yi(this),i.activate(),i.removeShape(t),this.filterArbiters(i,t),this.activeShapes.remove(t,t.hashid),t.space=null)},Ui.prototype.removeStaticShape=function(t){e(this.containsShape(t),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),Yi(this);
var i=t.body;i.isStatic()&&i.activateStatic(t),i.removeShape(t),this.filterArbiters(i,t),this.staticShapes.remove(t,t.hashid),t.space=null},Ui.prototype.removeBody=function(t){e(this.containsBody(t),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),Yi(this),t.activate(),o(this.bodies,t),t.space=null},Ui.prototype.removeConstraint=function(t){e(this.containsConstraint(t),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),Yi(this),t.a.activate(),t.b.activate(),o(this.constraints,t),t.a.removeConstraint(t),t.b.removeConstraint(t),t.space=null},Ui.prototype.containsShape=function(t){return t.space===this},Ui.prototype.containsBody=function(t){return t.space==this},Ui.prototype.containsConstraint=function(t){return t.space==this},Ui.prototype.uncacheArbiter=function(t){delete this.cachedArbiters[r(t.a.hashid,t.b.hashid)],o(this.arbiters,t)},Ui.prototype.eachBody=function(t){this.lock();for(var i=this.bodies,s=0;s<i.length;s++)t(i[s]);for(var e=this.sleepingComponents,s=0;s<e.length;s++)for(var n=e[s],r=n;r;){var o=r.nodeNext;t(r),r=o}this.unlock(!0)},Ui.prototype.eachShape=function(t){this.lock(),this.activeShapes.each(t),this.staticShapes.each(t),this.unlock(!0)},Ui.prototype.eachConstraint=function(t){this.lock();for(var i=this.constraints,s=0;s<i.length;s++)t(i[s]);this.unlock(!0)},Ui.prototype.reindexStatic=function(){e(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(t){var i=t.body;t.update(i.p,i.rot)}),this.staticShapes.reindex()},Ui.prototype.reindexShape=function(t){e(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var i=t.body;t.update(i.p,i.rot),this.activeShapes.reindexObject(t,t.hashid),this.staticShapes.reindexObject(t,t.hashid)},Ui.prototype.reindexShapesForBody=function(t){for(var i=t.shapeList;i;i=i.next)this.reindexShape(i)},Ui.prototype.useSpatialHash=function(t,i){throw Error("Spatial Hash not yet implemented!")},Ui.prototype.activateBody=function(t){if(e(!t.isRogue(),"Internal error: Attempting to activate a rogue body."),this.locked)-1===this.rousedBodies.indexOf(t)&&this.rousedBodies.push(t);else{this.bodies.push(t);for(var i=0;i<t.shapeList.length;i++){var s=t.shapeList[i];this.staticShapes.remove(s,s.hashid),this.activeShapes.insert(s,s.hashid)}for(var n=t.arbiterList;n;n=n.next(t)){var o=n.body_a;if(t===o||o.isStatic()){var a=n.a,h=n.b;this.cachedArbiters[r(a.hashid,h.hashid)]=n,n.stamp=this.stamp,n.handler=this.lookupHandler(a.collision_type,h.collision_type),this.arbiters.push(n)}}for(var c=t.constraintList;c;c=c.nodeNext){var o=c.a;(t===o||o.isStatic())&&this.constraints.push(c)}}},Ui.prototype.deactivateBody=function(t){e(!t.isRogue(),"Internal error: Attempting to deactivate a rogue body."),o(this.bodies,t);for(var i=0;i<t.shapeList.length;i++){var s=t.shapeList[i];this.activeShapes.remove(s,s.hashid),this.staticShapes.insert(s,s.hashid)}for(var n=t.arbiterList;n;n=n.next(t)){var r=n.body_a;(t===r||r.isStatic())&&this.uncacheArbiter(n)}for(var a=t.constraintList;a;a=a.nodeNext){var r=a.a;(t===r||r.isStatic())&&o(this.constraints,a)}};var Zi=function(t){return t?t.nodeRoot:null},Ki=function(t){if(t&&t.isSleeping(t)){e(!t.isRogue(),"Internal Error: componentActivate() called on a rogue body.");for(var i=t.space,s=t;s;){var n=s.nodeNext;s.nodeIdleTime=0,s.nodeRoot=null,s.nodeNext=null,i.activateBody(s),s=n}o(i.sleepingComponents,t)}};Z.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,Ki(Zi(this)))},Z.prototype.activateStatic=function(t){e(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var i=this.arbiterList;i;i=i.next(this))t&&t!=i.a&&t!=i.b||(i.body_a==this?i.body_b:i.body_a).activate()},Z.prototype.pushArbiter=function(t){n(null===(t.body_a===this?t.thread_a_next:t.thread_b_next),"Internal Error: Dangling contact graph pointers detected. (A)"),n(null===(t.body_a===this?t.thread_a_prev:t.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (B)");var i=this.arbiterList;n(null===i||null===(i.body_a===this?i.thread_a_prev:i.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (C)"),t.body_a===this?t.thread_a_next=i:t.thread_b_next=i,i&&(i.body_a===this?i.thread_a_prev=t:i.thread_b_prev=t),this.arbiterList=t};var Xi=function(t,i){i.nodeRoot=t,i!==t&&(i.nodeNext=t.nodeNext,t.nodeNext=i)},$i=function(t,i){if(!i.isRogue()){var s=Zi(i);if(null==s){Xi(t,i);for(var e=i.arbiterList;e;e=e.next(i))$i(t,i==e.body_a?e.body_b:e.body_a);for(var r=i.constraintList;r;r=r.next(i))$i(t,i==r.a?r.b:r.a)}else n(s===t,"Internal Error: Inconsistency detected in the contact graph.")}},ts=function(t,i){for(var s=t;s;s=s.nodeNext)if(s.nodeIdleTime<i)return!0;return!1};Ui.prototype.processComponents=function(t){for(var i=1/0!==this.sleepTimeThreshold,s=this.bodies,e=0;e<s.length;e++){var r=s[e];n(null===r.nodeNext,"Internal Error: Dangling next pointer detected in contact graph."),n(null===r.nodeRoot,"Internal Error: Dangling root pointer detected in contact graph.")}if(i)for(var o=this.idleSpeedThreshold,a=o?o*o:B(this.gravity)*t*t,e=0;e<s.length;e++){var r=s[e],h=a?r.m*a:0;r.nodeIdleTime=r.kineticEnergy()>h?0:r.nodeIdleTime+t}for(var c=this.arbiters,e=0,p=c.length;p>e;e++){var l=c[e],u=l.body_a,b=l.body_b;i&&((b.isRogue()&&!b.isStatic()||u.isSleeping())&&u.activate(),(u.isRogue()&&!u.isStatic()||b.isSleeping())&&b.activate()),u.pushArbiter(l),b.pushArbiter(l)}if(i){for(var v=this.constraints,e=0;e<v.length;e++){var y=v[e],u=y.a,b=y.b;b.isRogue()&&!b.isStatic()&&u.activate(),u.isRogue()&&!u.isStatic()&&b.activate()}for(var e=0;e<s.length;){var r=s[e];if(null!==Zi(r)||($i(r,r),ts(r,this.sleepTimeThreshold)))e++,r.nodeRoot=null,r.nodeNext=null;else{this.sleepingComponents.push(r);for(var d=r;d;d=d.nodeNext)this.deactivateBody(d)}}}},Z.prototype.sleep=function(){this.sleepWithGroup(null)},Z.prototype.sleepWithGroup=function(t){e(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var i=this.space;if(e(i,"Cannot put a rogue body to sleep."),e(!i.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),e(null===t||t.isSleeping(),"Cannot use a non-sleeping body as a group identifier."),this.isSleeping())return void e(Zi(this)===Zi(t),"The body is already sleeping and it's group cannot be reassigned.");for(var s=0;s<body.shapeList.length;s++)body.shapeList.update(this.p,this.rot);if(i.deactivateBody(this),t){var n=Zi(t);this.nodeRoot=n,this.nodeNext=n.nodeNext,this.nodeIdleTime=0,n.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,i.sleepingComponents.push(this);o(i.bodies,this)},Ui.prototype.activateShapesTouchingShape=function(t){1/0!==this.sleepTimeThreshold&&this.shapeQuery(t,function(t){t.body.activate()})},Ui.prototype.pointQuery=function(t,i,s,e){var n=function(n){(!n.group||s!==n.group)&&i&n.layers&&n.pointQuery(t)&&e(n)};this.lock(),this.activeShapes.pointQuery(t,n),this.staticShapes.pointQuery(t,n),this.unlock(!0)},Ui.prototype.pointQueryFirst=function(t,i,s){var e=null;return this.pointQuery(t,i,s,function(t){t.sensor||(e=t)}),e},Ui.prototype.segmentQuery=function(t,i,s,e,n){var r=function(r){var o;return(!r.group||e!==r.group)&&s&r.layers&&(o=r.segmentQuery(t,i))&&n(r,o.t,o.n),1};this.lock(),this.staticShapes.segmentQuery(t,i,1,r),this.activeShapes.segmentQuery(t,i,1,r),this.unlock(!0)},Ui.prototype.segmentQueryFirst=function(t,i,s,e){var n=null,r=function(r){var o;return r.group&&e===r.group||!(s&r.layers)||r.sensor||!(o=r.segmentQuery(t,i))||null!==n&&o.t>=n.t||(n=o),n?n.t:1};return this.staticShapes.segmentQuery(t,i,1,r),this.activeShapes.segmentQuery(t,i,n?n.t:1,r),n},Ui.prototype.bbQuery=function(t,i,s,e){var n=function(n){(!n.group||s!==n.group)&&i&n.layers&&R(t,n.bb_l,n.bb_b,n.bb_r,n.bb_t)&&e(n)};this.lock(),this.activeShapes.query(t,n),this.staticShapes.query(t,n),this.unlock(!0)},Ui.prototype.shapeQuery=function(t,i){var s=t.body;s&&t.update(s.p,s.rot);var e=new T(t.bb_l,t.bb_b,t.bb_r,t.bb_t),n=!1,r=function(s){var e=t;if((!e.group||e.group!==s.group)&&e.layers&s.layers&&e!==s){var r;if(e.collisionCode>s.collisionCode){r=cpCollideShapes(s,e);for(var o=0;o<r.length;o++)r[o].n=_(r[o].n)}else r=cpCollideShapes(e,s);if(r.length&&(n=!(e.sensor||s.sensor),i)){for(var a=Array(r.length),o=0;o<r.length;o++)a[o]=new Ci(r[o].p,r[o].n,r[o].dist);i(s,a)}}};return this.lock(),this.activeShapes.query(e,r),this.staticShapes.query(e,r),this.unlock(!0),n},Ui.prototype.addPostStepCallback=function(t){assertWarn(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(t)},Ui.prototype.runPostStepCallbacks=function(){for(var t=0;t<this.postStepCallbacks.length;t++)this.postStepCallbacks[t]()},Ui.prototype.lock=function(){this.locked++},Ui.prototype.unlock=function(t){if(this.locked--,e(this.locked>=0,"Internal Error: Space lock underflow."),!this.locked&&t){for(var i=this.rousedBodies,s=0;s<i.length;s++)this.activateBody(i[s]);i.length=0,this.runPostStepCallbacks()}},Ui.prototype.makeCollideShapes=function(){var t=this;return function(i,s){var e=t;if(//!bbIntersects(a.bb, b.bb)
!(i.bb_l>s.bb_r||s.bb_l>i.bb_r||i.bb_b>s.bb_t||s.bb_b>i.bb_t||i.body===s.body||i.group&&i.group===s.group)&&i.layers&s.layers){var n=e.lookupHandler(i.collision_type,s.collision_type),o=i.sensor||s.sensor;if(!o||n!==Ji){if(i.collisionCode>s.collisionCode){var a=i;i=s,s=a}var h=zi(i,s);if(0!==h.length){var c=r(i.hashid,s.hashid),p=e.cachedArbiters[c];p||(p=e.cachedArbiters[c]=new Bi(i,s)),p.update(h,n,i,s),"first coll"!=p.state||n.begin(p,e)||p.ignore(),"ignore"!==p.state&&n.preSolve(p,e)&&!o?e.arbiters.push(p):(p.contacts=null,"ignore"!==p.state&&(p.state="normal")),p.stamp=e.stamp}}}}},Ui.prototype.arbiterSetFilter=function(t){var i=this.stamp-t.stamp,s=t.body_a,e=t.body_b;return(s.isStatic()||s.isSleeping())&&(e.isStatic()||e.isSleeping())?!0:(1>i||"cached"==t.state||(t.callSeparate(this),t.state="cached"),i<this.collisionPersistence?!0:(t.contacts=null,!1))};var is=function(t){var i=t.body;t.update(i.p,i.rot)};Ui.prototype.step=function(t){if(0!==t){e(0===u.x&&0===u.y,"vzero is invalid"),this.stamp++;var i=this.curr_dt;this.curr_dt=t;for(var s=this.bodies,n=this.constraints,r=this.arbiters,o=0;o<r.length;o++){var a=r[o];a.state="normal",a.body_a.isSleeping()||a.body_b.isSleeping()||a.unthread()}r.length=0,this.lock();for(var o=0;o<s.length;o++){var h=s[o];h.position_func(t)}this.activeShapes.each(is),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(t),this.lock();for(var c in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[c])||delete this.cachedArbiters[c];for(var p=this.collisionSlop,l=1-Math.pow(this.collisionBias,t),o=0;o<r.length;o++)r[o].preStep(t,p,l);for(var o=0;o<n.length;o++){var b=n[o];b.preSolve(this),b.preStep(t)}for(var v=Math.pow(this.damping,t),y=this.gravity,o=0;o<s.length;o++){var h=s[o];h.velocity_func(y,v,t)}for(var d=0===i?0:t/i,o=0;o<r.length;o++)r[o].applyCachedImpulse(d);for(var o=0;o<n.length;o++){var b=n[o];b.applyCachedImpulse(d)}for(var o=0;o<this.iterations;o++){for(var f=0;f<r.length;f++)r[f].applyImpulse();for(var f=0;f<n.length;f++)n[f].applyImpulse()}for(var o=0;o<n.length;o++)n[o].postSolve(this);for(var o=0;o<r.length;o++){var a=r[o];a.handler.postSolve(a,this)}this.unlock(!0)}};var ss=function(t,i,s,e){var n=t.vx+-s.y*t.w,r=t.vy+s.x*t.w,o=i.vx+-e.y*i.w,a=i.vy+e.x*i.w;return new l(o-n,a-r)},es=function(t,i,s,e,n){var r=t.vx+-s.y*t.w,o=t.vy+s.x*t.w,a=i.vx+-e.y*i.w,h=i.vy+e.x*i.w;return v(a-r,h-o,n.x,n.y)},ns=function(t,i,s,e){t.vx+=i*t.m_inv,t.vy+=s*t.m_inv,t.w+=t.i_inv*(e.x*s-e.y*i)},rs=function(t,i,s,e,n,r){ns(t,-n,-r,s),ns(i,n,r,e)},os=function(t,i,s,e){t.v_biasx+=i*t.m_inv,t.v_biasy+=s*t.m_inv,t.w_bias+=t.i_inv*g(e.x,e.y,i,s)},as=function(t,i,s){var e=m(i,s);return t.m_inv+t.i_inv*e*e},hs=function(t,i,s,e,r){var o=as(t,s,r)+as(i,e,r);return n(0!==o,"Unsolvable collision or constraint."),o},cs=function(t,i,s,e,r,o){var a,h,c,p,l=t.m_inv+i.m_inv;a=l,h=0,c=0,p=l;var u=t.i_inv,b=s.x*s.x*u,v=s.y*s.y*u,y=-s.x*s.y*u;a+=v,h+=y,c+=y,p+=b;var d=i.i_inv,f=e.x*e.x*d,_=e.y*e.y*d,x=-e.x*e.y*d;a+=_,h+=x,c+=x,p+=f;var m=a*p-h*c;n(0!==m,"Unsolvable constraint.");var g=1/m;r.x=p*g,r.y=-h*g,o.x=-c*g,o.y=a*g},ps=function(t,i,s){return new l(b(t,i),b(t,s))},ls=function(t,i){return 1-Math.pow(t,i)},us=t.Constraint=function(t,i){this.a=t,this.b=i,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=1/0,this.errorBias=Math.pow(.9,60),this.maxBias=1/0};us.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},us.prototype.preStep=function(){},us.prototype.applyCachedImpulse=function(){},us.prototype.applyImpulse=function(){},us.prototype.getImpulse=function(){return 0},us.prototype.preSolve=function(){},us.prototype.postSolve=function(){},us.prototype.next=function(t){return this.a===t?this.next_a:this.next_b};var bs=t.PinJoint=function(t,i,s,e){us.call(this,t,i),this.anchr1=s,this.anchr2=e;var r=t?d(t.p,A(s,t.rot)):s,o=i?d(i.p,A(e,i.rot)):e;this.dist=y(f(o,r)),n(this.dist>0,"You created a 0 length pin joint. A pivot joint will be much more stable."),this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};bs.prototype=Object.create(us.prototype),bs.prototype.preStep=function(t){var i=this.a,s=this.b;this.r1=A(this.anchr1,i.rot),this.r2=A(this.anchr2,s.rot);var e=f(d(s.p,this.r2),d(i.p,this.r1)),n=y(e);this.n=x(e,1/(n?n:1/0)),this.nMass=1/hs(i,s,this.r1,this.r2,this.n);var r=this.maxBias;this.bias=h(-ls(this.errorBias,t)*(n-this.dist)/t,-r,r),this.jnMax=this.maxForce*t},bs.prototype.applyCachedImpulse=function(t){var i=x(this.n,this.jnAcc*t);rs(this.a,this.b,this.r1,this.r2,i.x,i.y)},bs.prototype.applyImpulse=function(){var t=this.a,i=this.b,s=this.n,e=es(t,i,this.r1,this.r2,s),n=(this.bias-e)*this.nMass,r=this.jnAcc;this.jnAcc=h(r+n,-this.jnMax,this.jnMax),n=this.jnAcc-r,rs(t,i,this.r1,this.r2,s.x*n,s.y*n)},bs.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var vs=t.SlideJoint=function(t,i,s,e,n,r){us.call(this,t,i),this.anchr1=s,this.anchr2=e,this.min=n,this.max=r,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};vs.prototype=Object.create(us.prototype),vs.prototype.preStep=function(t){var i=this.a,s=this.b;this.r1=A(this.anchr1,i.rot),this.r2=A(this.anchr2,s.rot);var e=f(d(s.p,this.r2),d(i.p,this.r1)),n=y(e),r=0;n>this.max?(r=n-this.max,this.n=I(e)):n<this.min?(r=this.min-n,this.n=_(I(e))):(this.n=u,this.jnAcc=0),this.nMass=1/hs(i,s,this.r1,this.r2,this.n);var o=this.maxBias;this.bias=h(-ls(this.errorBias,t)*r/t,-o,o),this.jnMax=this.maxForce*t},vs.prototype.applyCachedImpulse=function(t){var i=this.jnAcc*t;rs(this.a,this.b,this.r1,this.r2,this.n.x*i,this.n.y*i)},vs.prototype.applyImpulse=function(){if(0!==this.n.x||0!==this.n.y){var t=this.a,i=this.b,s=this.n,e=this.r1,n=this.r2,r=ss(t,i,e,n),o=b(r,s),a=(this.bias-o)*this.nMass,c=this.jnAcc;this.jnAcc=h(c+a,-this.jnMax,0),a=this.jnAcc-c,rs(t,i,this.r1,this.r2,s.x*a,s.y*a)}},vs.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var ys=t.PivotJoint=function(t,i,s,e){if(us.call(this,t,i),void 0===e){var n=s;s=t?t.world2Local(n):n,e=i?i.world2Local(n):n}this.anchr1=s,this.anchr2=e,this.r1=this.r2=u,this.k1=new l(0,0),this.k2=new l(0,0),this.jAcc=u,this.jMaxLen=0,this.bias=u};ys.prototype=Object.create(us.prototype),ys.prototype.preStep=function(t){var i=this.a,s=this.b;this.r1=A(this.anchr1,i.rot),this.r2=A(this.anchr2,s.rot),cs(i,s,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*t;var e=f(d(s.p,this.r2),d(i.p,this.r1));this.bias=k(x(e,-ls(this.errorBias,t)/t),this.maxBias)},ys.prototype.applyCachedImpulse=function(t){rs(this.a,this.b,this.r1,this.r2,this.jAcc.x*t,this.jAcc.y*t)},ys.prototype.applyImpulse=function(){var t=this.a,i=this.b,s=this.r1,e=this.r2,n=ss(t,i,s,e),r=ps(f(this.bias,n),this.k1,this.k2),o=this.jAcc;this.jAcc=k(d(this.jAcc,r),this.jMaxLen),rs(t,i,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},ys.prototype.getImpulse=function(){return y(this.jAcc)};var ds=t.GrooveJoint=function(t,i,s,e,n){us.call(this,t,i),this.grv_a=s,this.grv_b=e,this.grv_n=w(M(f(e,s))),this.anchr2=n,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new l(0,0),this.k2=new l(0,0),this.jAcc=u,this.jMaxLen=0,this.bias=null};ds.prototype=Object.create(us.prototype),ds.prototype.preStep=function(t){var i=this.a,s=this.b,e=i.local2World(this.grv_a),n=i.local2World(this.grv_b),r=A(this.grv_n,i.rot),o=b(e,r);this.grv_tn=r,this.r2=A(this.anchr2,s.rot);var a=m(d(s.p,this.r2),r);a>m(e,r)?a<m(n,r)?(this.clamp=0,this.r1=f(d(x(w(r),-a),x(r,o)),i.p)):(this.clamp=-1,this.r1=f(n,i.p)):(this.clamp=1,this.r1=f(e,i.p)),cs(i,s,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*t;var h=f(d(s.p,this.r2),d(i.p,this.r1));this.bias=k(x(h,-ls(this.errorBias,t)/t),this.maxBias)},ds.prototype.applyCachedImpulse=function(t){rs(this.a,this.b,this.r1,this.r2,this.jAcc.x*t,this.jAcc.y*t)},ds.prototype.grooveConstrain=function(t){var i=this.grv_tn,s=this.clamp*m(t,i)>0?t:S(t,i);return k(s,this.jMaxLen)},ds.prototype.applyImpulse=function(){var t=this.a,i=this.b,s=this.r1,e=this.r2,n=ss(t,i,s,e),r=ps(f(this.bias,n),this.k1,this.k2),o=this.jAcc;this.jAcc=this.grooveConstrain(d(o,r)),rs(t,i,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},ds.prototype.getImpulse=function(){return y(this.jAcc)},ds.prototype.setGrooveA=function(t){this.grv_a=t,this.grv_n=w(M(f(this.grv_b,t))),this.activateBodies()},ds.prototype.setGrooveB=function(t){this.grv_b=t,this.grv_n=w(M(f(t,this.grv_a))),this.activateBodies()};var fs=function(t,i){return(t.restLength-i)*t.stiffness},_s=t.DampedSpring=function(t,i,s,e,n,r,o){us.call(this,t,i),this.anchr1=s,this.anchr2=e,this.restLength=n,this.stiffness=r,this.damping=o,this.springForceFunc=fs,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};_s.prototype=Object.create(us.prototype),_s.prototype.preStep=function(t){var i=this.a,s=this.b;this.r1=A(this.anchr1,i.rot),this.r2=A(this.anchr2,s.rot);var e=f(d(s.p,this.r2),d(i.p,this.r1)),r=y(e);this.n=x(e,1/(r?r:1/0));var o=hs(i,s,this.r1,this.r2,this.n);n(0!==o,"Unsolvable this."),this.nMass=1/o,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*t*o);var a=this.springForceFunc(this,r);rs(i,s,this.r1,this.r2,this.n.x*a*t,this.n.y*a*t)},_s.prototype.applyCachedImpulse=function(){},_s.prototype.applyImpulse=function(){var t=this.a,i=this.b,s=this.n,e=this.r1,n=this.r2,r=es(t,i,e,n,s),o=(this.target_vrn-r)*this.v_coef;this.target_vrn=r+o,o*=this.nMass,rs(t,i,this.r1,this.r2,this.n.x*o,this.n.y*o)},_s.prototype.getImpulse=function(){return 0};var xs=function(t,i){return(i-t.restAngle)*t.stiffness},ms=t.DampedRotarySpring=function(t,i,s,e,n){us.call(this,t,i),this.restAngle=s,this.stiffness=e,this.damping=n,this.springTorqueFunc=xs,this.target_wrn=0,this.w_coef=0,this.iSum=0};ms.prototype=Object.create(us.prototype),ms.prototype.preStep=function(t){var i=this.a,s=this.b,e=i.i_inv+s.i_inv;n(0!==e,"Unsolvable spring."),this.iSum=1/e,this.w_coef=1-Math.exp(-this.damping*t*e),this.target_wrn=0;var r=this.springTorqueFunc(this,i.a-s.a)*t;i.w-=r*i.i_inv,s.w+=r*s.i_inv},ms.prototype.applyImpulse=function(){var t=this.a,i=this.b,s=t.w-i.w,e=(this.target_wrn-s)*this.w_coef;this.target_wrn=s+e;var n=e*this.iSum;t.w+=n*t.i_inv,i.w-=n*i.i_inv};var gs=t.RotaryLimitJoint=function(t,i,s,e){us.call(this,t,i),this.min=s,this.max=e,this.jAcc=0,this.iSum=this.bias=this.jMax=0};gs.prototype=Object.create(us.prototype),gs.prototype.preStep=function(t){var i=this.a,s=this.b,e=s.a-i.a,n=0;e>this.max?n=this.max-e:e<this.min&&(n=this.min-e),this.iSum=1/(1/i.i+1/s.i);var r=this.maxBias;this.bias=h(-ls(this.errorBias,t)*n/t,-r,r),this.jMax=this.maxForce*t,this.bias||(this.jAcc=0)},gs.prototype.applyCachedImpulse=function(t){var i=this.a,s=this.b,e=this.jAcc*t;i.w-=e*i.i_inv,s.w+=e*s.i_inv},gs.prototype.applyImpulse=function(){if(this.bias){var t=this.a,i=this.b,s=i.w-t.w,e=-(this.bias+s)*this.iSum,n=this.jAcc;this.jAcc=this.bias<0?h(n+e,0,this.jMax):h(n+e,-this.jMax,0),e=this.jAcc-n,t.w-=e*t.i_inv,i.w+=e*i.i_inv}},gs.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var ws=t.RatchetJoint=function(t,i,s,e){us.call(this,t,i),this.angle=0,this.phase=s,this.ratchet=e,this.angle=(i?i.a:0)-(t?t.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};ws.prototype=Object.create(us.prototype),ws.prototype.preStep=function(t){var i=this.a,s=this.b,e=this.angle,n=this.phase,r=this.ratchet,o=s.a-i.a,a=e-o,c=0;a*r>0?c=a:this.angle=Math.floor((o-n)/r)*r+n,this.iSum=1/(i.i_inv+s.i_inv);var p=this.maxBias;this.bias=h(-ls(this.errorBias,t)*c/t,-p,p),this.jMax=this.maxForce*t,this.bias||(this.jAcc=0)},ws.prototype.applyCachedImpulse=function(t){var i=this.a,s=this.b,e=this.jAcc*t;i.w-=e*i.i_inv,s.w+=e*s.i_inv},ws.prototype.applyImpulse=function(){if(this.bias){var t=this.a,i=this.b,s=i.w-t.w,e=this.ratchet,n=-(this.bias+s)*this.iSum,r=this.jAcc;this.jAcc=h((r+n)*e,0,this.jMax*Math.abs(e))/e,n=this.jAcc-r,t.w-=n*t.i_inv,i.w+=n*i.i_inv}},ws.prototype.getImpulse=function(t){return Math.abs(t.jAcc)};var Ss=t.GearJoint=function(t,i,s,e){us.call(this,t,i),this.phase=s,this.ratio=e,this.ratio_inv=1/e,this.jAcc=0,this.iSum=this.bias=this.jMax=0};Ss.prototype=Object.create(us.prototype),Ss.prototype.preStep=function(t){var i=this.a,s=this.b;this.iSum=1/(i.i_inv*this.ratio_inv+this.ratio*s.i_inv);var e=this.maxBias;this.bias=h(-ls(this.errorBias,t)*(s.a*this.ratio-i.a-this.phase)/t,-e,e),this.jMax=this.maxForce*t},Ss.prototype.applyCachedImpulse=function(t){var i=this.a,s=this.b,e=this.jAcc*t;i.w-=e*i.i_inv*this.ratio_inv,s.w+=e*s.i_inv},Ss.prototype.applyImpulse=function(){var t=this.a,i=this.b,s=i.w*this.ratio-t.w,e=(this.bias-s)*this.iSum,n=this.jAcc;this.jAcc=h(n+e,-this.jMax,this.jMax),e=this.jAcc-n,t.w-=e*t.i_inv*this.ratio_inv,i.w+=e*i.i_inv},Ss.prototype.getImpulse=function(){return Math.abs(this.jAcc)},Ss.prototype.setRatio=function(t){this.ratio=t,this.ratio_inv=1/t,this.activateBodies()};var As=t.SimpleMotor=function(t,i,s){us.call(this,t,i),this.rate=s,this.jAcc=0,this.iSum=this.jMax=0};As.prototype=Object.create(us.prototype),As.prototype.preStep=function(t){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*t},As.prototype.applyCachedImpulse=function(t){var i=this.a,s=this.b,e=this.jAcc*t;i.w-=e*i.i_inv,s.w+=e*s.i_inv},As.prototype.applyImpulse=function(){var t=this.a,i=this.b,s=i.w-t.w+this.rate,e=-s*this.iSum,n=this.jAcc;this.jAcc=h(n+e,-this.jMax,this.jMax),e=this.jAcc-n,t.w-=e*t.i_inv,i.w+=e*i.i_inv},As.prototype.getImpulse=function(){return Math.abs(this.jAcc)}}();